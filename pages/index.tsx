import type { NextPage } from 'next'
import Head from 'next/head'
import SidebarContent from '../components/sidebar-content'
import ItemList from '../components/itemlist'
import { useQuery, useQueries } from '@tanstack/react-query'
import { fetchTopStories, fetchItem } from '../util/api'

const Home: NextPage = () => {
  const {
    isError: isTopStoriesError,
    isLoading: isLoadingTopStories,
    data: topStoryIds,
    error: topStoriesError,
  } = useQuery(['topStories'], fetchTopStories)

  const storyData = useQueries({
    queries:
      topStoryIds?.slice(0, 10)?.map((itemId) => ({
        queryKey: ['item', itemId],
        queryFn: () => fetchItem(itemId),
        enabled: !!topStoryIds,
      })) || [],
  })

  const allSuccess =
    storyData && storyData.every((story) => story.isSuccess === true)

  if (isTopStoriesError && topStoriesError instanceof Error) {
    return <p>{topStoriesError.message}</p>
  }

  return (
    <div>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main>
        <div className="flex h-screen">
          <div className="sticky h-full bg-slate-100 w-60">
            <SidebarContent />
          </div>
          <div className="h-full flex-1 px-8 overflow-scroll">
            {!allSuccess && <p>Loading...</p>}
            {allSuccess && <ItemList items={storyData.map((sd) => sd.data!)} />}
          </div>
        </div>
      </main>
    </div>
  )
}

export default Home
